<%= if admin?(@conn) do %>
  <div class="float-right">
    <%= link raw("<i class=\"fas fa-pencil-alt mr-2\"></i>Edit"),
      to: topic_path(@conn, :edit, @topic),
      class: "btn btn-outline-dark"
    %>
    <%= link raw("<i class=\"far fa-trash-alt mr-2\"></i>Delete"),
      to: topic_path(@conn, :delete, @topic),
      method: :delete,
      data: [confirm: "Are you sure?"],
      class: "btn btn-outline-danger"
    %>
  </div>
<% end %>

<h2><%= @topic.title %></h2>
<%= raw @topic.desc %>
<hr>

<div class="row">
  <div class="col-md">
    <div class="card">
      <div class="card-header">
        <%= if admin?(@conn) || ( user?(@conn) && @topic.open ) do %>
          <button class="btn btn-success float-right"
            data-toggle="modal" data-target="#submitIdeaModal"
          >
            <i class="fas fa-plus mr-2"></i><%= gettext "Submit Idea" %>
          </button>
        <% end %>
        <h3><%= gettext "Ideas" %></h3>
      </div>
      <div class="card-body pl-0 pr-0">
        <table id="ideas" class="mr-0 table table-sm table-striped table-hover" cellspacing="0" cellpadding="0">
          <thead>
            <tr>
              <th>Title</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
        <%= for idea <- @ideas do %>
            <tr data-path="<%= topic_idea_path @conn, :show, @topic.id, idea.id %>" class="pointer">
              <td><%= idea.title %></td>
              <td class="text-right" data-order="<%= idea.created %>">
                <small>
                  <time datetime="<%= NaiveDateTime.to_iso8601(idea.created) %>Z"></time>
                </small>
              </td>
            </tr>
        <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <%= if !@idea do %>
    <div class="col-md">
      <div class="card">
        <div class="card-body">
          <p class="card-text font-italic">
            <%= gettext "Please select an idea from the list on the left to show comments and further details." %>
          </p>
        </div>
      </div>
    </div>
  <% else %>
    <div class="col-md">
      <div class="card">
        <div class="card-header">
          <%= if admin?(@conn) do %>
            <div class="float-right">
              <button class="btn btn-outline-dark btn-sm" data-toggle="modal" data-target="#editIdeaModal">
                <i class="fas fa-pencil-alt"></i>
              </button>
              <%= link raw("<i class=\"far fa-trash-alt\"></i>"),
                to: topic_idea_path(@conn, :delete, @topic, @idea),
                method: :delete,
                data: [confirm: "Are you sure?"],
                class: "btn btn-sm btn-outline-danger"
              %>
            </div>
          <% end %>
          <h4><%= @idea.title %></h4>
        </div>
        <%= if @idea.desc do %>
          <div class="card-body"><%= @idea.desc %></div>
        <% end %>

          <ul id="comments" class="list-group list-group-flush">
            <%= if Enum.count(@idea.comments) > 0 do %>
              <%= for comment <- @idea.comments do %>
                <li class="list-group-item px-2 py-1" data-id="<%= comment.id %>">
                  <small class="ml-1 float-right font-italic text-muted">
                    <time datetime="<%= comment.inserted_at %>Z"></time>
                    <%= if admin?(@conn) do %>
                      <a class="delete-comment pointer">
                        <i class="text-danger fas fa-trash-alt"></i>
                      </a>
                    <% end %>
                  </small>
                  <strong><%= comment.user.name %></strong>
                  <%= comment.text %>
                </li>
              <% end %>
            <% else %>
              <li id="no_feedback" class="list-group-item px-2 py-1 font-italic text-center">
                no feedback yet...
              </li>
            <% end %>
          </ul>
        <%= if admin?(@conn) || ( user?(@conn) && @topic.open )do %>
          <div class="card-footer">
            <input id="feedback" class="form-control form-control-sm"
              placeholder="Leave feedback..." />
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<!-- Add Idea Modal -->
<%= if admin?(@conn) || ( user?(@conn) && @topic.open ) do %>
<div
  id="submitIdeaModal"
  class="modal fade"  tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true"
  data-show="<%= !!@idea_changeset.action %>"
>

  <%= form_for @idea_changeset, topic_idea_path(@conn, :create, @topic), fn f -> %>

  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">
          <%= gettext "Add Idea" %>
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <%= if !!@idea_changeset.action do %>
          <div class="alert alert-danger alert-dismissible fade show">
            <strong>Error:</strong> Invalid/Incomplete form data
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        <% end %>
        <div class="form-group">
          <%= label f, :title, class: "control-label" %>
          <%= text_input f, :title, class: "form-control #{error_class f, :title}" %>
          <%= error_tag f, :title %>
        </div>

        <div class="form-group">
          <%= label f, :desc, class: "control-label" %>
          <%= textarea f, :desc, class: "form-control #{error_class f, :desc}" %>
          <%= error_tag f, :desc %>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <%= submit "Submit", class: "btn btn-primary" %>
      </div>
    </div>
  </div>
  <% end %>
</div>
<% end %>

<!-- Edit Idea Modal -->
<%= if user?(@conn) && @topic.open && @idea do %>
<div
  id="editIdeaModal"
  class="modal fade"  tabindex="-1" role="dialog"
  aria-labelledby="exampleModalLabel" aria-hidden="true"
  data-show="<%= !!@edit_idea_changeset.action %>"
>
  <%= form_for @edit_idea_changeset, topic_idea_path(@conn, :update, @topic, @idea), fn f -> %>

  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">
          <%= gettext "Edit Idea" %>
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <%= if !!@edit_idea_changeset.action do %>
          <div class="alert alert-danger alert-dismissible fade show">
            <strong>Error:</strong> Invalid/Incomplete form data
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        <% end %>
        <div class="form-group">
          <%= label f, :title, class: "control-label" %>
          <%= text_input f, :title, class: "form-control #{error_class f, :title}" %>
          <%= error_tag f, :title %>
        </div>

        <div class="form-group">
          <%= label f, :desc, class: "control-label" %>
          <%= textarea f, :desc, class: "form-control #{error_class f, :desc}" %>
          <%= error_tag f, :desc %>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <%= submit "Submit", class: "btn btn-primary" %>
      </div>
    </div>
  </div>
  <% end %>
</div>
<% end %>